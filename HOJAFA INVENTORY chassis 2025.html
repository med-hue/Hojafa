<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chassis Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Basic body styling */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f8e7; /* Light green background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
        }

        /* Container for the main application content */
        #container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 95%; /* Use a percentage for better responsiveness */
            max-width: 800px; /* Increased max-width for larger screens */
            text-align: center;
            border: 2px solid #c6e48b; /* Light green border */
            margin: 20px auto; /* Center the container and add vertical margin */
        }

        /* Title styling */
        h1 {
            color: #4caf50; /* Green title */
            margin-bottom: 20px;
        }

        /* Navigation button container */
        #navigation {
            margin-bottom: 20px;
            display: flex; /* Use flexbox for button layout */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center; /* Center buttons horizontally */
            gap: 10px; /* Add space between buttons */
        }

        /* Navigation button styling */
        #navigation button {
            background-color: #8bc34a; /* Slightly different green for nav */
            padding: 10px 15px; /* Adjust padding */
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease; /* Smooth transition */
            flex-grow: 1; /* Allow buttons to grow to fill space */
            max-width: 150px; /* Limit max width of buttons */
        }

        #navigation button:hover {
            background-color: #7cb342; /* Darker green on hover */
        }

        /* Styling for different views */
        .view {
            display: none; /* Hide all views by default */
            text-align: left;
            padding-top: 10px; /* Add some space above the view content */
        }

        /* Style for the active view */
        .view.active {
            display: block; /* Show the active view */
        }

        /* Basic form group styling */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #0c3001; /* Dark green label color */
            font-weight: bold;
        }

        .form-group input[type="text"] {
            width: calc(100% - 22px); /* Calculate width considering padding and border */
            padding: 10px;
            border: 1px solid #c6e48b; /* Light green border */
            border-radius: 6px;
            box-sizing: border-box; /* Include padding and border in width */
            transition: border-color 0.3s ease; /* Smooth transition */
        }

        .form-group input[type="text"]:focus {
            border-color: #4caf50; /* Highlight on focus with green */
            outline: none; /* Remove default outline */
        }

        /* Style for file input to hide default appearance */
        input[type="file"] {
            display: none;
        }

        /* Style for the custom file input label (looks like a button) */
        .custom-file-upload {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #8bc34a; /* Slightly different green */
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        .custom-file-upload:hover {
             background-color: #7cb342; /* Darker green on hover */
        }


        /* General button styling */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #4caf50; /* Green button */
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease; /* Smooth transition */
            margin: 5px; /* Add margin around buttons */
        }

        button:hover {
            background-color: #45a049; /* Darker green on hover */
        }

        /* Style for the delete button */
        button.delete-btn {
            background-color: #f44336; /* Red color for delete */
            padding: 5px 10px; /* Smaller padding for delete button */
            font-size: 0.9em;
        }

        button.delete-btn:hover {
            background-color: #d32f2f; /* Darker red on hover */
        }


        /* Canvas styling for inventory display */
        #inventoryCanvas {
            border: 1px solid #c6e48b;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #f8f8f8;
            width: 100%; /* Make canvas responsive */
            display: block; /* Remove extra space below canvas */
        }

        /* History table styling */
        #historyTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #historyTable th, #historyTable td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        #historyTable th {
            background-color: #4caf50;
            color: white;
        }

        #historyTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Style for the message box */
        #message-box {
            position: fixed; /* Use fixed positioning */
            top: 20px; /* Position from the top */
            left: 50%; /* Center horizontally initially */
            transform: translateX(-50%); /* Precise centering */
            background-color: #4CAF50; /* Green background for success */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Ensure it's above other elements */
            opacity: 1; /* Fully visible initially */
            transition: opacity 0.5s ease-in-out, top 0.5s ease-in-out; /* Smooth transition */
            white-space: nowrap; /* Prevent text wrapping */
            max-width: 90%; /* Limit max width on smaller screens */
            text-align: center; /* Center text inside message box */
        }

        /* Style for error messages */
        #message-box.error {
            background-color: #f44336; /* Red background for errors */
        }

        /* Style for hiding the message box */
        #message-box.hidden {
            opacity: 0;
            top: -50px; /* Move it above the viewport */
        }

        /* Styling for the count displays in Inventory view */
        .inventory-counts {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #0c3001;
        }

        .inventory-counts span {
            font-weight: bold;
            color: #4caf50; /* Green color for counts */
        }

        /* Styling for the Bill of Lading breakdown section */
        #billOfLadingBreakdown {
            margin-top: 20px;
            border-top: 1px solid #c6e48b;
            padding-top: 15px;
            text-align: left;
        }

        #billOfLadingBreakdown h3 {
            color: #0c3001;
            margin-bottom: 10px;
        }

        #billOfLadingBreakdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #billOfLadingBreakdown li {
            margin-bottom: 8px;
            padding: 8px;
            background-color: #e9f5d8; /* Lighter green background for list items */
            border-radius: 4px;
            border: 1px solid #c6e48b;
        }

        #billOfLadingBreakdown li strong {
            color: #4caf50; /* Green color for BOL number */
        }

        /* Styling for the search bar container */
        .search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-container input[type="text"] {
            flex-grow: 1; /* Allow input to take up available space */
            padding: 10px;
            border: 1px solid #c6e48b;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .search-container button {
            padding: 10px 15px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div id="container">
        <h1>Chassis Management</h1>

        <div id="navigation">
            <button id="nav-checkin">Check-In</button>
            <button id="nav-checkout">Check-Out</button>
            <button id="nav-inventory">Inventory</button>
            <button id="nav-history">History</button>
        </div>

        <div id="message-box" class="hidden"></div>

        <div id="checkin-view" class="view active">
            <h2>Check-In Chassis</h2>
            <form id="checkinForm" class="form">
                <div class="form-group">
                    <label for="checkinChassisNumber">Chassis Number:</label>
                    <input type="text" id="checkinChassisNumber" name="checkinChassisNumber" required>
                </div>
                 <div class="form-group">
                    <label for="checkinBillOfLading">Bill of Lading Number:</label>
                    <input type="text" id="checkinBillOfLading" name="checkinBillOfLading">
                </div>
                <button type="submit">Check-In</button>
            </form>
        </div>

        <div id="checkout-view" class="view">
            <h2>Check-Out Chassis</h2>
            <form id="checkoutForm" class="form">
                <div class="form-group">
                    <label for="checkoutChassisNumber">Chassis Number:</label>
                    <input type="text" id="checkoutChassisNumber" name="checkoutChassisNumber" required>
                </div>
                <div class="form-group">
                    <label for="checkoutCustomerName">Customer Name:</label>
                    <input type="text" id="checkoutCustomerName" name="checkoutCustomerName" required>
                </div>
                <button type="submit">Check-Out</button>
            </form>
        </div>

        <div id="inventory-view" class="view">
            <h2>Current Inventory</h2>
            <p class="inventory-counts">Total Checked In: <span id="totalCheckedIn">0</span></p>
            <p class="inventory-counts">Total Checked Out: <span id="totalCheckedOut">0</span></p>

            <div id="billOfLadingBreakdown">
                <h3>Breakdown by Bill of Lading</h3>
                <ul id="billOfLadingList">
                    </ul>
            </div>

            <canvas id="inventoryCanvas"></canvas>
        </div>

        <div id="history-view" class="view">
            <h2>Transaction History</h2>
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="exportHistory">Export to CSV</button>
                    <label for="importExcel" class="custom-file-upload">
                        Import from Excel
                    </label>
                    <input type="file" id="importExcel" accept=".xlsx, .xls">
                </div>
                 <div class="search-container">
                    <input type="text" id="chassisSearchInput" placeholder="Search by Chassis Number">
                    <button id="searchChassisButton">Search</button>
                </div>
            </div>

            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Chassis Number</th>
                        <th>Type</th>
                        <th>Customer</th>
                        <th>Bill of Lading</th> <th>Date/Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        // Get references to DOM elements
        const checkinForm = document.getElementById('checkinForm');
        const checkoutForm = document.getElementById('checkoutForm');
        const inventoryCanvas = document.getElementById('inventoryCanvas');
        // Get the 2D rendering context for the canvas
        const ctx = inventoryCanvas.getContext('2d');
        const historyTableBody = document.querySelector('#historyTable tbody');
        const messageBox = document.getElementById('message-box');
        const exportHistoryButton = document.getElementById('exportHistory'); // Get the export button
        const importExcelInput = document.getElementById('importExcel'); // Get the file input
        const chassisSearchInput = document.getElementById('chassisSearchInput'); // Get the search input
        const searchChassisButton = document.getElementById('searchChassisButton'); // Get the search button


        // Elements for displaying counts
        const totalCheckedInElement = document.getElementById('totalCheckedIn');
        const totalCheckedOutElement = document.getElementById('totalCheckedOut');

        // Input element for Bill of Lading
        const checkinBillOfLadingInput = document.getElementById('checkinBillOfLading');

        // New element for Bill of Lading breakdown list
        const billOfLadingListElement = document.getElementById('billOfLadingList');


        // Navigation buttons
        const navCheckin = document.getElementById('nav-checkin');
        const navCheckout = document.getElementById('nav-checkout');
        const navInventory = document.getElementById('nav-inventory');
        const navHistory = document.getElementById('nav-history');

        // View divs
        const checkinView = document.getElementById('checkin-view');
        const checkoutView = document.getElementById('checkout-view');
        const inventoryView = document.getElementById('inventory-view');
        const historyView = document.getElementById('history-view');

        // Array to store all transactions (check-in and check-out)
        // Initialize transactions by loading from local storage when the script starts
        let transactions = loadTransactions();

        // Variable to store the current search term
        let currentSearchTerm = '';

        // Configuration for drawing chassis blocks on canvas
        const blockWidth = 150;
        const blockHeight = 40;
        const blockMargin = 10;
        const canvasPadding = 20; // Padding inside the canvas

        // Function to display messages (success or error)
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            // Set class for styling (success or error)
            messageBox.className = `message-box ${type}`;
            // Remove hidden class to show the box
            messageBox.classList.remove('hidden');

            // Hide the message after a few seconds
            setTimeout(() => {
                messageBox.classList.add('hidden'); // Add hidden class to hide the box
            }, 3000); // Hide after 3 seconds
        }

        // Function to save transactions to local storage
        function saveTransactions() {
            try {
                // Convert Date objects to ISO strings before saving
                const transactionsToSave = transactions.map(transaction => ({
                    chassisNumber: transaction.chassisNumber,
                    type: transaction.type,
                    customerName: transaction.customerName || '', // Include customerName, default to empty string if not present
                    billOfLading: transaction.billOfLading || '', // Include billOfLading, default to empty string
                    timestamp: transaction.timestamp.toISOString() // Save Date as ISO string
                }));
                // Save the stringified array to local storage
                localStorage.setItem('chassisTransactions', JSON.stringify(transactionsToSave));
            } catch (e) {
                console.error('Error saving to local storage:', e);
                showMessage('Could not save data locally.', 'error');
            }
        }

        // Function to load transactions from local storage
        function loadTransactions() {
            try {
                // Get the stored data from local storage
                const storedTransactions = localStorage.getItem('chassisTransactions');
                if (storedTransactions) {
                    // Parse the JSON string back into an array
                    const parsedTransactions = JSON.parse(storedTransactions);
                    // Convert timestamp strings back to Date objects and handle new billOfLading field
                    return parsedTransactions.map(transaction => ({
                        chassisNumber: transaction.chassisNumber,
                        type: transaction.type,
                        customerName: transaction.customerName || '', // Load customerName, default to empty string
                        billOfLading: transaction.billOfLading || '', // Load billOfLading, default to empty string
                        timestamp: new Date(transaction.timestamp) // Convert string back to Date object
                    }));
                }
            } catch (e) {
                console.error('Error loading from local storage:', e);
                showMessage('Could not load data from local storage.', 'error');
            }
            // Return empty array if no data or an error occurred
            return [];
        }

        // Function to show a specific view and hide others
        function showView(viewId) {
            const views = document.querySelectorAll('.view');
            // Hide all views
            views.forEach(view => {
                view.classList.remove('active');
            });
            // Show the requested view
            document.getElementById(viewId).classList.add('active');

            // Redraw canvas or history when their view is activated
            if (viewId === 'inventory-view') {
                drawInventory();
            } else if (viewId === 'history-view') {
                drawHistory(); // Ensure history is redrawn when navigating to it
            }
        }

        // Function to get the list of currently checked-in chassis
        function getCurrentInventory() {
            const currentInventory = new Set();
            const lastTransaction = {}; // To track the last transaction for each chassis

            // Iterate through transactions to find the most recent transaction for each chassis
            transactions.forEach(transaction => {
                 // Use chassisNumber as the key to track the last transaction for each chassis
                 if (!lastTransaction[transaction.chassisNumber] || transaction.timestamp > lastTransaction[transaction.chassisNumber].timestamp) {
                     lastTransaction[transaction.chassisNumber] = transaction;
                 }
            });

            // Add chassis to current inventory if their last transaction was 'check-in'
            for (const chassisNumber in lastTransaction) {
                if (lastTransaction[chassisNumber].type === 'check-in') {
                    currentInventory.add(chassisNumber);
                }
            }

            // Convert the Set of chassis numbers to an Array
            return Array.from(currentInventory);
        }

        // Function to draw the current inventory on the canvas and update counts and breakdown
        function drawInventory() {
            const currentInventory = getCurrentInventory();

            // Calculate total check-ins and check-outs
            let totalCheckIns = 0;
            let totalCheckOuts = 0;

            // Object to store check-in and check-out counts per Bill of Lading
            const billOfLadingCounts = {};

            // Count check-in and check-out transactions and aggregate by Bill of Lading
            transactions.forEach(transaction => {
                if (transaction.type === 'check-in') {
                    totalCheckIns++;
                    const bol = transaction.billOfLading || 'No BOL'; // Use 'No BOL' for empty
                    if (!billOfLadingCounts[bol]) {
                        billOfLadingCounts[bol] = { in: 0, out: 0 };
                    }
                    billOfLadingCounts[bol].in++;
                } else if (transaction.type === 'check-out') {
                    totalCheckOuts++;
                    // For check-outs, we need to find the associated check-in transaction to get the BOL
                    // Search backwards from the current transaction to find the most recent check-in for the same chassis
                    const associatedCheckIn = transactions.slice().reverse().find(t =>
                        t.chassisNumber === transaction.chassisNumber && t.type === 'check-in' && t.timestamp < transaction.timestamp
                    );
                    const bol = associatedCheckIn ? (associatedCheckIn.billOfLading || 'No BOL') : 'No BOL (Check-out without prior Check-in)';
                     if (!billOfLadingCounts[bol]) {
                         billOfLadingCounts[bol] = { in: 0, out: 0 };
                     }
                    billOfLadingCounts[bol].out++;
                }
            });

            // Update the display elements with the calculated overall counts
            totalCheckedInElement.textContent = totalCheckIns;
            totalCheckedOutElement.textContent = totalCheckOuts;

            // Clear the current Bill of Lading breakdown list
            billOfLadingListElement.innerHTML = '';

            // Display the breakdown by Bill of Lading
            const sortedBOLs = Object.keys(billOfLadingCounts).sort(); // Sort BOLs alphabetically
            sortedBOLs.forEach(bol => {
                const counts = billOfLadingCounts[bol];
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${bol}:</strong> Checked In: ${counts.in}, Checked Out: ${counts.out}`;
                billOfLadingListElement.appendChild(listItem);
            });

            // Display a message if there are no BOLs
            if (sortedBOLs.length === 0 && transactions.length > 0) {
                 const listItem = document.createElement('li');
                 listItem.textContent = 'No Bill of Lading data available in transactions.';
                 billOfLadingListElement.appendChild(listItem);
            } else if (transactions.length === 0) {
                 const listItem = document.createElement('li');
                 listItem.textContent = 'No transaction data available.';
                 billOfLadingListElement.appendChild(listItem);
            }


            // Get the actual width of the canvas element (accounting for CSS styling)
            const canvasWidth = inventoryCanvas.clientWidth;
            // Calculate how many blocks fit in a row based on the current canvas width
            const blocksPerRow = Math.floor((canvasWidth - 2 * canvasPadding + blockMargin) / (blockWidth + blockMargin));

            // Ensure blocksPerRow is at least 1 to avoid division by zero if canvas is too small
            const safeBlocksPerRow = blocksPerRow > 0 ? blocksPerRow : 1;

            // Calculate the required number of rows based on the number of chassis and blocks per row
            const numRows = Math.ceil(currentInventory.length / safeBlocksPerRow);

            // Calculate the required height for the canvas based on the number of rows
            const requiredHeight = numRows * (blockHeight + blockMargin) + 2 * canvasPadding;

            // Set the canvas height (this also clears the canvas)
            // Ensure a minimum height even if no items are present
            inventoryCanvas.height = requiredHeight > 100 ? requiredHeight : 100;
            // Set canvas width to match client width for proper scaling
            inventoryCanvas.width = canvasWidth;


            // Clear the canvas before drawing
            ctx.clearRect(0, 0, inventoryCanvas.width, inventoryCanvas.height);

            // Set text properties for drawing chassis numbers
            ctx.font = '14px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center'; // Center text horizontally within the block
            ctx.textBaseline = 'middle'; // Vertically center text within the block

            // Draw each chassis as a block on the canvas
            currentInventory.forEach((chassis, index) => {
                // Calculate row and column for the current chassis block
                const row = Math.floor(index / safeBlocksPerRow);
                const col = index % safeBlocksPerRow;

                // Calculate the x and y position for the block
                const x = canvasPadding + col * (blockWidth + blockMargin);
                const y = canvasPadding + row * (blockHeight + blockMargin);

                // Draw the block (rectangle)
                ctx.fillStyle = '#c6e48b'; // Light green for blocks
                ctx.fillRect(x, y, blockWidth, blockHeight);

                // Draw the chassis number text inside the block
                ctx.fillStyle = '#0c3001'; // Dark green for text
                // Calculate text position (center of the block)
                const textX = x + blockWidth / 2;
                const textY = y + blockHeight / 2;
                // Draw the text, limiting its width to prevent overflow
                ctx.fillText(chassis, textX, textY, blockWidth - 10);
            });

            // Display a message if there are no chassis in inventory
            if (currentInventory.length === 0) {
                ctx.fillStyle = '#333';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText('No chassis in inventory.', canvasPadding, canvasPadding);
            }
        }

        // Function to draw the transaction history in the table
        function drawHistory() {
            // Clear the current table body content
            historyTableBody.innerHTML = '';

            // Determine which transactions to display (all or filtered)
            const transactionsToDisplay = currentSearchTerm
                ? transactions.filter(transaction =>
                      transaction.chassisNumber.toLowerCase().includes(currentSearchTerm.toLowerCase())
                  )
                : transactions;

            // Display a message if there is no transaction history or no results for the search
            if (transactionsToDisplay.length === 0) {
                const row = historyTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 6; // Span across all columns (including new Bill of Lading and Actions)
                cell.textContent = currentSearchTerm
                    ? `No results found for "${currentSearchTerm}".`
                    : 'No transaction history available.';
                cell.style.textAlign = 'center';
                return;
            }

            // Sort transactions by timestamp in descending order (newest first)
            const sortedTransactions = transactionsToDisplay.slice().sort((a, b) => b.timestamp - a.timestamp);

            // Add each transaction as a row to the history table
            sortedTransactions.forEach((transaction, index) => {
                const row = historyTableBody.insertRow();
                const chassisCell = row.insertCell(0);
                const typeCell = row.insertCell(1);
                const customerCell = row.insertCell(2); // Cell for customer name
                const billOfLadingCell = row.insertCell(3); // New cell for Bill of Lading
                const dateCell = row.insertCell(4); // Shifted date cell
                const actionsCell = row.insertCell(5); // Shifted actions cell

                chassisCell.textContent = transaction.chassisNumber;
                // Display "Check-In" or "Check-Out" based on transaction type
                typeCell.textContent = transaction.type === 'check-in' ? 'Check-In' : 'Check-Out';
                // Display customer name or an empty string if not available
                customerCell.textContent = transaction.customerName || '';
                // Display Bill of Lading or an empty string if not available
                billOfLadingCell.textContent = transaction.billOfLading || '';
                // Display formatted date and time
                dateCell.textContent = transaction.timestamp.toLocaleString();

                // Add a delete button to the actions cell
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('delete-btn'); // Add class for styling
                // Store the ORIGINAL index of the transaction in a data attribute
                // This is crucial for deleting the correct item from the original transactions array
                const originalIndex = transactions.findIndex(t =>
                    t.chassisNumber === transaction.chassisNumber &&
                    t.type === transaction.type &&
                    t.customerName === transaction.customerName &&
                    t.billOfLading === transaction.billOfLading && // Include Bill of Lading in find criteria
                    t.timestamp.getTime() === transaction.timestamp.getTime() // Compare timestamps
                );
                deleteButton.dataset.originalIndex = originalIndex;
                actionsCell.appendChild(deleteButton);
            });
        }

        // Function to handle deleting a transaction
        function deleteTransaction(originalIndex) {
            console.log('Attempting to delete transaction at original index:', originalIndex); // Log the index being used

            // Check if the index is valid
            if (originalIndex > -1 && originalIndex < transactions.length) {
                // Remove the transaction at the specified original index
                transactions.splice(originalIndex, 1);
                console.log('Transaction removed from array. New transactions array:', transactions); // Log the array after removal
                saveTransactions(); // Save the updated transactions
                drawHistory(); // Redraw the history table (will now reflect deletion and any active search)
                drawInventory(); // Redraw the inventory to update counts
                showMessage('Transaction deleted successfully.');
            } else {
                console.error('Invalid index for deletion:', originalIndex); // Log if the index is invalid
                showMessage('Error deleting transaction.', 'error');
            }
        }

        // Function to export history data to a CSV file
        function exportHistoryToCsv() {
            if (transactions.length === 0) {
                showMessage('No history to export.', 'error');
                return;
            }

            // Define CSV headers (including Customer and Bill of Lading headers)
            const headers = ['Chassis Number', 'Type', 'Customer', 'Bill of Lading', 'Date/Time'];

            // Format transaction data into CSV rows
            const csvRows = transactions.map(transaction => {
                // Basic escaping for commas and quotes in data fields
                const escapeCsv = (value) => `"${String(value).replace(/"/g, '""')}"`;

                const chassis = escapeCsv(transaction.chassisNumber);
                const type = escapeCsv(transaction.type === 'check-in' ? 'Check-In' : 'Check-Out');
                const customer = escapeCsv(transaction.customerName || ''); // Escape customer name
                const billOfLading = escapeCsv(transaction.billOfLading || ''); // Escape Bill of Lading
                const dateTime = escapeCsv(transaction.timestamp.toLocaleString());

                // Join fields with commas
                return `${chassis},${type},${customer},${billOfLading},${dateTime}`; // Include Bill of Lading in the CSV row
            });

            // Combine headers and data rows with newline characters
            const csvString = [headers.join(','), ...csvRows].join('\n');

            // Create a Blob object from the CSV string
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });

            // Create a temporary anchor element for downloading
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'chassis_history.csv'); // Set the filename for download

            // Append the link to the body, trigger a click, and then remove the link
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage('History exported to chassis_history.csv');
        }

        // Function to handle importing data from an Excel file
        function importHistoryFromExcel(event) {
            const file = event.target.files[0]; // Get the selected file

            if (!file) {
                return; // Exit if no file was selected
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assuming the data is in the first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert the worksheet data to a JSON array of objects
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Process the imported data
                const importedTransactions = [];
                // Updated expected headers to include Bill of Lading
                const expectedHeaders = ['Chassis Number', 'Type', 'Customer', 'Bill of Lading', 'Date/Time'];
                const headerRow = jsonData[0];

                // Basic header validation
                if (!headerRow || !expectedHeaders.every(header => headerRow.includes(header))) {
                     showMessage('Invalid Excel file format. Missing required headers.', 'error');
                     return;
                }

                // Find column indices (updated for new column)
                const chassisIndex = headerRow.indexOf('Chassis Number');
                const typeIndex = headerRow.indexOf('Type');
                const customerIndex = headerRow.indexOf('Customer');
                const billOfLadingIndex = headerRow.indexOf('Bill of Lading'); // New index
                const dateTimeIndex = headerRow.indexOf('Date/Time'); // Shifted index

                // Process data rows (skip header row)
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const chassisNumber = row[chassisIndex];
                    const type = row[typeIndex];
                    const customerName = row[customerIndex] || ''; // Handle missing customer name
                    const billOfLading = row[billOfLadingIndex] || ''; // Handle missing Bill of Lading
                    const timestampStr = row[dateTimeIndex];

                    // Basic data validation
                    if (chassisNumber && (type === 'Check-In' || type === 'Check-Out') && timestampStr) {
                        const timestamp = new Date(timestampStr);
                        if (!isNaN(timestamp)) { // Check if the date is valid
                             importedTransactions.push({
                                 chassisNumber: String(chassisNumber).trim(), // Ensure string and trim whitespace
                                 type: type === 'Check-In' ? 'check-in' : 'check-out', // Convert to internal type
                                 customerName: String(customerName).trim(), // Ensure string and trim whitespace
                                 billOfLading: String(billOfLading).trim(), // Ensure string and trim whitespace for Bill of Lading
                                 timestamp: timestamp
                             });
                        } else {
                            console.warn(`Skipping row ${i + 1}: Invalid Date/Time format "${timestampStr}"`);
                        }
                    } else {
                        console.warn(`Skipping row ${i + 1}: Missing required data or invalid type.`);
                    }
                }

                // Merge or replace existing transactions (here we replace for simplicity)
                transactions = importedTransactions;
                saveTransactions(); // Save the imported transactions

                // Update the displays
                drawInventory();
                drawHistory();

                showMessage(`Successfully imported ${importedTransactions.length} transactions from Excel.`);
            };

            reader.onerror = function(ex) {
                console.error('Error reading Excel file:', ex);
                showMessage('Error reading Excel file.', 'error');
            };

            // Read the file as an ArrayBuffer
            reader.readAsArrayBuffer(file);
        }

        // Function to handle search input
        function handleSearch() {
            currentSearchTerm = chassisSearchInput.value.trim();
            drawHistory(); // Redraw history with the new search term
        }


        // Handle window resizing to redraw the canvas for responsiveness
        window.addEventListener('resize', () => {
             // Only redraw inventory if the inventory view is currently active
             if (inventoryView.classList.contains('active')) {
                 drawInventory();
             }
        });

        // Handle the check-in form submission
        function handleCheckin(event) {
            event.preventDefault(); // Prevent default form submission
            const chassisNumberInput = document.getElementById('checkinChassisNumber');
            const chassisNumber = chassisNumberInput.value.trim();
            const billOfLading = checkinBillOfLadingInput.value.trim(); // Get Bill of Lading value


            // Validate chassis number input
            if (!chassisNumber) {
                showMessage('Please enter a chassis number.', 'error');
                return;
            }

            // Check if the chassis is already checked in
            const currentInventory = getCurrentInventory();
            if (currentInventory.includes(chassisNumber)) {
                showMessage('Chassis is already checked in.', 'error');
                return;
            }

            // Add a new check-in transaction (including Bill of Lading)
            transactions.push({
                chassisNumber: chassisNumber,
                type: 'check-in',
                customerName: '', // No customer name for check-in
                billOfLading: billOfLading, // Include Bill of Lading
                timestamp: new Date() // Record current timestamp
            });

            saveTransactions(); // Save the updated transactions to local storage

            // Update the inventory display and history table
            drawInventory();
            drawHistory();
            chassisNumberInput.value = ''; // Clear the input field
            checkinBillOfLadingInput.value = ''; // Clear Bill of Lading input
            showMessage(`Chassis ${chassisNumber} checked in successfully.`);
        }

        // Handle the check-out form submission
        function handleCheckout(event) {
            event.preventDefault(); // Prevent default form submission
            const chassisNumberInput = document.getElementById('checkoutChassisNumber');
            const chassisNumber = chassisNumberInput.value.trim();
            const customerNameInput = document.getElementById('checkoutCustomerName'); // Get customer name input
            const customerName = customerNameInput.value.trim(); // Get customer name value

            // Validate chassis number input
            if (!chassisNumber) {
                 showMessage('Please enter a chassis number.', 'error');
                 return;
            }

            // Validate customer name input
             if (!customerName) {
                 showMessage('Please enter a customer name.', 'error'); // Require customer name for checkout
                 return;
             }

            // Check if the chassis is currently checked in
            const currentInventory = getCurrentInventory();
            if (!currentInventory.includes(chassisNumber)) {
                 showMessage('Chassis is not currently checked in.', 'error');
                 return;
             }

            // Add a new check-out transaction (Bill of Lading will be empty for checkout)
            transactions.push({
                chassisNumber: chassisNumber,
                type: 'check-out',
                customerName: customerName, // Include customer name
                billOfLading: '', // Bill of Lading is not typically associated with checkout
                timestamp: new Date() // Record current timestamp
            });

            saveTransactions(); // Save the updated transactions to local storage

            // Update the displays
            drawInventory();
            drawHistory();
            chassisNumberInput.value = ''; // Clear chassis number input
            customerNameInput.value = ''; // Clear customer name input
            showMessage(`Chassis ${chassisNumber} checked out to ${customerName} successfully.`);
        }

        // Add event listeners for form submissions
        checkinForm.addEventListener('submit', handleCheckin);
        checkoutForm.addEventListener('submit', handleCheckout);

        // Add event listeners for navigation buttons to switch views
        navCheckin.addEventListener('click', () => showView('checkin-view'));
        navCheckout.addEventListener('click', () => showView('checkout-view'));
        navInventory.addEventListener('click', () => showView('inventory-view'));
        navHistory.addEventListener('click', () => showView('history-view'));

        // Add event listener for the export history button
        exportHistoryButton.addEventListener('click', exportHistoryToCsv);

        // Add event listener for the file input change event
        importExcelInput.addEventListener('change', importHistoryFromExcel);

        // Add event listeners for the search input and button
        chassisSearchInput.addEventListener('input', handleSearch); // Filter as user types
        searchChassisButton.addEventListener('click', handleSearch); // Filter on button click


        // Add event listener to the history table body for delete button clicks
        historyTableBody.addEventListener('click', (event) => {
            console.log('Click event on history table body:', event.target); // Log the clicked element
            // Check if the clicked element is a delete button or within one
            const deleteButton = event.target.closest('.delete-btn');
            if (deleteButton) {
                console.log('Delete button clicked.'); // Confirm delete button was the target
                // Get the original index from the data attribute
                const originalIndexToDelete = parseInt(deleteButton.dataset.originalIndex);
                 console.log('Original index from data attribute:', deleteButton.dataset.originalIndex); // Log the data attribute value
                 console.log('Parsed original index:', originalIndexToDelete); // Log the parsed integer

                // Confirm deletion with the user
                if (confirm('Are you sure you want to delete this transaction?')) {
                    deleteTransaction(originalIndexToDelete); // Call the delete function with the original index
                }
            }
        });


        // Initialize the application when the window finishes loading
        window.onload = function() {
            // Load transactions from local storage
            transactions = loadTransactions();
            // Show the initial view (Check-In)
            showView('checkin-view');
            // Draw the initial inventory and history based on loaded data
            drawInventory();
            drawHistory();
        };

    </script>
</body>
</html>
